generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// User & Order Enums
enum UserType {
  customer
  admin
}

enum OrderStatus {
  pending
  confirmed
  printing
  shipped
  delivered
  cancelled
}

// Print Specification Enums
enum PrintSize {
  A4
  A3
  A5
  SQUARE_20CM
  SQUARE_30CM
  CUSTOM
}

enum Material {
  MATTE
  GLOSSY
  CANVAS
  FINE_ART
}

enum Orientation {
  PORTRAIT
  LANDSCAPE
  SQUARE
}

// Product Catalog Enums
enum ProductCategory {
  SUBLIMATION
  STATIONERY
  LARGE_FORMAT
  PHOTO_PRINTS
  DIGITAL
  CUSTOM_ORDER
}

enum ProductType {
  TSHIRT
  MUG
  WATER_BOTTLE
  MOUSEMAT
  KEYCHAIN
  CUSHION_PILLOW
  BUSINESS_CARD
  LEAFLET
  GREETING_CARD
  POSTCARD
  BANNER
  POSTER
  CANVAS_PRINT
  ALUMINUM_PRINT
  PHOTO_PAPER_PRINT
  ACRYLIC_LED_PRINT
  DIGITAL_PDF
}

enum CustomizationType {
  TEMPLATE_BASED
  UPLOAD_OWN
  FULLY_CUSTOM
  DIGITAL_DOWNLOAD
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

// Financial Enums
enum PaymentMethod {
  STRIPE
  PAYPAL
  CARD
  BANK_TRANSFER
  CASH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  MATERIALS
  PACKAGING
  SHIPPING_SUPPLIES
  EQUIPMENT
  SOFTWARE
  UTILITIES
  MARKETING
  OTHER
}

enum ReportPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// ============================================
// CORE MODELS
// ============================================

model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          UserType
  email         String   @unique @db.VarChar(255)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  name          String   @db.VarChar(255)
  profile       Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  designs         Design[]
  orders          Order[]
  reviews         Review[]
  refreshTokens   RefreshToken[]
  preferences     UserPreference?

  @@index([email])
  @@index([type])
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  tokenHash   String   @map("token_hash") @db.VarChar(255)
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Design {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  title        String?      @db.VarChar(255)
  fileUrl      String       @map("file_url") @db.VarChar(500)

  // Print specifications for preview
  printSize    PrintSize?   @map("print_size")
  material     Material?
  orientation  Orientation?
  printWidth   Int?         @map("print_width")  // Width in millimeters
  printHeight  Int?         @map("print_height") // Height in millimeters

  // Preview/mockup
  previewUrl   String?      @map("preview_url") @db.VarChar(500)

  // Flexible metadata for additional customization
  metadata     Json?        @db.JsonB
  createdAt    DateTime     @default(now()) @map("created_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders     Order[]
  orderItems OrderItem[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("designs")
}

// ============================================
// PRODUCT CATALOG MODELS
// ============================================

model Category {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @db.VarChar(255)
  slug         String   @unique @db.VarChar(255)
  description  String?  @db.Text
  image        String?  @db.VarChar(500)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  subcategories Subcategory[]
  products      Product[]

  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("categories")
}

model Subcategory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId   String   @map("category_id") @db.Uuid
  name         String   @db.VarChar(255)
  slug         String   @unique @db.VarChar(255)
  description  String?  @db.Text
  image        String?  @db.VarChar(500)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  category     Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products     Product[]

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("subcategories")
}

model Product {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String         @db.VarChar(255)
  slug            String         @unique @db.VarChar(255)
  description     String         @db.Text

  // Dynamic category relations
  categoryId      String         @map("category_id") @db.Uuid
  subcategoryId   String?        @map("subcategory_id") @db.Uuid

  // Legacy enum fields (kept for backward compatibility during migration)
  legacyCategory  ProductCategory? @map("legacy_category")
  legacyProductType ProductType?  @map("legacy_product_type")

  customizationType CustomizationType @map("customization_type")

  // Pricing
  basePrice       Decimal        @map("base_price") @db.Decimal(10, 2)
  currency        String         @default("GBP") @db.VarChar(3)

  // Status and visibility
  status          ProductStatus  @default(DRAFT)
  featured        Boolean        @default(false)

  // SEO
  seoTitle        String?        @map("seo_title") @db.VarChar(255)
  seoDescription  String?        @map("seo_description") @db.VarChar(500)
  seoKeywords     String?        @map("seo_keywords") @db.VarChar(500)

  // Flexible metadata
  metadata        Json?          @db.JsonB

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @default(now()) @updatedAt @map("updated_at")

  category        Category         @relation(fields: [categoryId], references: [id])
  subcategory     Subcategory?     @relation(fields: [subcategoryId], references: [id])
  variants        ProductVariant[]
  images          ProductImage[]
  templates       ProductTemplate[]
  orderItems      OrderItem[]

  @@index([slug])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([legacyCategory])
  @@index([legacyProductType])
  @@index([status])
  @@index([featured])
  @@map("products")
}

model ProductVariant {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId       String    @map("product_id") @db.Uuid

  name            String    @db.VarChar(255)
  sku             String?   @unique @db.VarChar(100)

  // Variant attributes
  size            String?   @db.VarChar(50)
  material        String?   @db.VarChar(100)
  color           String?   @db.VarChar(50)
  finish          String?   @db.VarChar(50)
  dimensions      Json?     @db.JsonB // { width, height, depth, unit }

  // Pricing and inventory
  price           Decimal   @db.Decimal(10, 2) // Additional cost on top of base price
  stock           Int       @default(0)
  isDefault       Boolean   @default(false) @map("is_default")

  // Flexible metadata
  metadata        Json?     @db.JsonB

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  images          ProductImage[]
  orderItems      OrderItem[]

  @@index([productId])
  @@index([sku])
  @@index([material])
  @@index([size])
  @@map("product_variants")
}

model ProductImage {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId       String          @map("product_id") @db.Uuid
  variantId       String?         @map("variant_id") @db.Uuid

  imageUrl        String          @map("image_url") @db.VarChar(500)
  altText         String?         @map("alt_text") @db.VarChar(255)
  displayOrder    Int             @default(0) @map("display_order")
  isPrimary       Boolean         @default(false) @map("is_primary")

  createdAt       DateTime        @default(now()) @map("created_at")

  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([displayOrder])
  @@map("product_images")
}

model ProductTemplate {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId       String    @map("product_id") @db.Uuid

  name            String    @db.VarChar(255)
  description     String?   @db.Text
  thumbnailUrl    String    @map("thumbnail_url") @db.VarChar(500)
  designFileUrl   String    @map("design_file_url") @db.VarChar(500)

  // Categorization
  category        String?   @db.VarChar(100) // "Birthday", "Wedding", "Business", etc.
  tags            Json?     @db.JsonB // Array of tags

  // Premium templates
  isPremium       Boolean   @default(false) @map("is_premium")
  price           Decimal?  @db.Decimal(10, 2)

  // Flexible metadata
  metadata        Json?     @db.JsonB

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([category])
  @@index([isPremium])
  @@map("product_templates")
}

model OrderItem {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId          String          @map("order_id") @db.Uuid

  // Product references (for catalog products)
  productId        String?         @map("product_id") @db.Uuid
  variantId        String?         @map("variant_id") @db.Uuid

  // Design reference (for custom designs or legacy orders)
  designId         String?         @map("design_id") @db.Uuid

  // Item details
  quantity         Int             @default(1)
  unitPrice        Decimal         @map("unit_price") @db.Decimal(10, 2)
  totalPrice       Decimal         @map("total_price") @db.Decimal(10, 2)

  // Customization and metadata
  customization    Json?           @db.JsonB
  metadata         Json?           @db.JsonB

  createdAt        DateTime        @default(now()) @map("created_at")

  order            Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product?        @relation(fields: [productId], references: [id])
  variant          ProductVariant? @relation(fields: [variantId], references: [id])
  design           Design?         @relation(fields: [designId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@index([designId])
  @@map("order_items")
}

model Order {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId       String      @map("customer_id") @db.Uuid
  designId         String?     @map("design_id") @db.Uuid // Made optional for multi-item orders
  status           OrderStatus @default(pending)

  // Snapshot of print specifications at order time (legacy/single-item orders)
  printSize        PrintSize?  @map("print_size")
  material         Material?
  orientation      Orientation?
  printWidth       Int?        @map("print_width")  // Width in millimeters
  printHeight      Int?        @map("print_height") // Height in millimeters
  previewUrl       String?     @map("preview_url") @db.VarChar(500)

  // Pricing and shipping
  totalPrice       Decimal     @map("total_price") @db.Decimal(10, 2)
  shippingAddress  Json        @map("shipping_address") @db.JsonB

  // Royal Mail integration
  royalmailOrderId String?     @map("royalmail_order_id") @db.VarChar(255)
  trackingNumber   String?     @map("tracking_number") @db.VarChar(255)
  carrier          String?     @db.VarChar(50)

  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @default(now()) @updatedAt @map("updated_at")

  customer        User      @relation(fields: [customerId], references: [id])
  design          Design?   @relation(fields: [designId], references: [id])
  items           OrderItem[]
  review          Review?
  invoice         Invoice?
  payment         Payment?
  inventoryUsages InventoryUsage[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([trackingNumber])
  @@map("orders")
}

model Review {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String   @unique @map("order_id") @db.Uuid
  reviewerId String   @map("reviewer_id") @db.Uuid
  rating     Int
  comment    String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  order    Order @relation(fields: [orderId], references: [id])
  reviewer User  @relation(fields: [reviewerId], references: [id])

  @@index([orderId])
  @@index([rating])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

model UserPreference {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @unique @map("user_id") @db.Uuid
  preferences Json?    @db.JsonB
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_preferences")
}

// ============================================
// FINANCIAL MODELS
// ============================================

model Invoice {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber  String        @unique @map("invoice_number") @db.VarChar(50) // e.g., INV-2025-0001
  orderId        String        @unique @map("order_id") @db.Uuid

  // Amounts
  subtotal       Decimal       @db.Decimal(10, 2)
  vatRate        Decimal       @map("vat_rate") @db.Decimal(5, 2) // e.g., 20.00 for 20%
  vatAmount      Decimal       @map("vat_amount") @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)

  // Currency
  currency       String        @default("GBP") @db.VarChar(3)
  exchangeRate   Decimal?      @map("exchange_rate") @db.Decimal(10, 4) // For currency conversion

  // Dates and Status
  issueDate      DateTime      @map("issue_date") @default(now())
  dueDate        DateTime      @map("due_date")
  status         InvoiceStatus @default(DRAFT)

  // PDF Storage
  pdfUrl         String?       @map("pdf_url") @db.VarChar(500)

  // Metadata
  notes          String?       @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @default(now()) @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id])

  @@index([invoiceNumber])
  @@index([status])
  @@index([issueDate(sort: Desc)])
  @@map("invoices")
}

model Payment {
  id                 String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId            String        @unique @map("order_id") @db.Uuid

  // Payment Details
  amount             Decimal       @db.Decimal(10, 2)
  currency           String        @default("GBP") @db.VarChar(3)
  paymentMethod      PaymentMethod @map("payment_method")
  status             PaymentStatus @default(PENDING)

  // Gateway Integration
  stripePaymentId    String?       @map("stripe_payment_id") @db.VarChar(255)
  paypalTransactionId String?      @map("paypal_transaction_id") @db.VarChar(255)
  gatewayResponse    Json?         @map("gateway_response") @db.JsonB

  // Timestamps
  paidAt             DateTime?     @map("paid_at")
  refundedAt         DateTime?     @map("refunded_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @default(now()) @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id])

  @@index([status])
  @@index([paymentMethod])
  @@index([paidAt(sort: Desc)])
  @@map("payments")
}

model Expense {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseNumber  String          @unique @map("expense_number") @db.VarChar(50) // e.g., EXP-2025-0001

  // Expense Details
  category       ExpenseCategory
  description    String          @db.VarChar(500)
  amount         Decimal         @db.Decimal(10, 2)
  currency       String          @default("GBP") @db.VarChar(3)
  exchangeRate   Decimal?        @map("exchange_rate") @db.Decimal(10, 4)

  // Supplier
  supplierId     String?         @map("supplier_id") @db.Uuid

  // Documentation
  receiptUrl     String?         @map("receipt_url") @db.VarChar(500)

  // Product Search Metadata (for Google search results, price comparison)
  searchMetadata Json?           @map("search_metadata") @db.JsonB

  // Dates
  purchaseDate   DateTime        @map("purchase_date") @default(now())
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @default(now()) @updatedAt @map("updated_at")

  // Notes
  notes          String?         @db.Text

  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  inventoryAdditions InventoryAddition[]

  @@index([category])
  @@index([supplierId])
  @@index([purchaseDate(sort: Desc)])
  @@map("expenses")
}

model Supplier {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @db.VarChar(255)
  contactInfo Json?    @map("contact_info") @db.JsonB // email, phone, address
  website     String?  @db.VarChar(500)
  rating      Decimal? @db.Decimal(3, 2) // e.g., 4.50 out of 5.00
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  expenses Expense[]

  @@index([name])
  @@map("suppliers")
}

// ============================================
// INVENTORY MODELS
// ============================================

model Inventory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  itemName        String   @map("item_name") @db.VarChar(255)
  category        ExpenseCategory // Same categories as expenses
  description     String?  @db.Text

  // Stock Tracking
  currentStock    Int      @map("current_stock") @default(0)
  unit            String   @db.VarChar(50) // e.g., "sheets", "ml", "units"
  reorderPoint    Int?     @map("reorder_point") // Alert when stock falls below this
  reorderQuantity Int?     @map("reorder_quantity") // Suggested reorder amount

  // Costing (for profit margin calculations)
  unitCost        Decimal? @map("unit_cost") @db.Decimal(10, 2)
  currency        String   @default("GBP") @db.VarChar(3)

  // Metadata
  sku             String?  @unique @db.VarChar(100)
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  additions InventoryAddition[]
  usages    InventoryUsage[]

  @@index([itemName])
  @@index([category])
  @@index([currentStock])
  @@map("inventory")
}

model InventoryAddition {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String   @map("inventory_id") @db.Uuid
  expenseId   String?  @map("expense_id") @db.Uuid
  quantity    Int
  unitCost    Decimal? @map("unit_cost") @db.Decimal(10, 2)
  notes       String?  @db.Text
  addedAt     DateTime @map("added_at") @default(now())

  inventory Inventory @relation(fields: [inventoryId], references: [id])
  expense   Expense?  @relation(fields: [expenseId], references: [id])

  @@index([inventoryId])
  @@index([expenseId])
  @@index([addedAt(sort: Desc)])
  @@map("inventory_additions")
}

model InventoryUsage {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String   @map("inventory_id") @db.Uuid
  orderId     String?  @map("order_id") @db.Uuid
  quantity    Int
  notes       String?  @db.Text
  usedAt      DateTime @map("used_at") @default(now())

  inventory Inventory @relation(fields: [inventoryId], references: [id])
  order     Order?    @relation(fields: [orderId], references: [id])

  @@index([inventoryId])
  @@index([orderId])
  @@index([usedAt(sort: Desc)])
  @@map("inventory_usages")
}

// ============================================
// REPORTING MODELS
// ============================================

model FinancialReport {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  period        ReportPeriod
  startDate     DateTime     @map("start_date")
  endDate       DateTime     @map("end_date")

  // Financial Summary
  totalRevenue  Decimal      @map("total_revenue") @db.Decimal(10, 2)
  totalExpenses Decimal      @map("total_expenses") @db.Decimal(10, 2)
  netProfit     Decimal      @map("net_profit") @db.Decimal(10, 2)
  vatCollected  Decimal      @map("vat_collected") @db.Decimal(10, 2)

  // Order Statistics
  orderCount    Int          @map("order_count")

  // Detailed Data (JSON for charts/graphs)
  reportData    Json         @map("report_data") @db.JsonB

  // PDF Storage
  pdfUrl        String?      @map("pdf_url") @db.VarChar(500)

  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([period])
  @@index([startDate, endDate])
  @@index([createdAt(sort: Desc)])
  @@map("financial_reports")
}
