generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                UserType
  email               String               @unique @db.VarChar(255)
  passwordHash        String               @map("password_hash") @db.VarChar(255)
  name                String               @db.VarChar(255)
  profile             Json?
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  designs             Design[]
  orders              Order[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  reviews             Review[]
  preferences         UserPreference?
  wishlistItems       WishlistItem[]
  cartItems           CartItem[]
  recoveryCampaigns   RecoveryCampaign[]
  lastRecoveryEmailAt DateTime?            @map("last_recovery_email_at")

  @@index([email])
  @@index([type])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Design {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  title       String?      @db.VarChar(255)
  fileUrl     String       @map("file_url") @db.VarChar(500)
  printSize   PrintSize?   @map("print_size")
  material    Material?
  orientation Orientation?
  printWidth  Int?         @map("print_width")
  printHeight Int?         @map("print_height")
  previewUrl  String?      @map("preview_url") @db.VarChar(500)
  metadata    Json?
  createdAt   DateTime     @default(now()) @map("created_at")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  orders      Order[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("designs")
}

model Category {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String        @db.VarChar(255)
  slug          String        @unique @db.VarChar(255)
  description   String?
  image         String?       @db.VarChar(500)
  displayOrder  Int           @default(0) @map("display_order")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at")
  products      Product[]
  subcategories Subcategory[]

  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("categories")
}

model Subcategory {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId   String    @map("category_id") @db.Uuid
  name         String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  description  String?
  image        String?   @db.VarChar(500)
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")
  products     Product[]
  category     Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("subcategories")
}

model Product {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String            @db.VarChar(255)
  slug              String            @unique @db.VarChar(255)
  description       String
  legacyCategory    ProductCategory   @map("legacy_category")
  legacyProductType ProductType       @map("legacy_product_type")
  customizationType CustomizationType @map("customization_type")
  basePrice         Decimal           @map("base_price") @db.Decimal(10, 2)
  currency          String            @default("GBP") @db.VarChar(3)
  status            ProductStatus     @default(DRAFT)
  featured          Boolean           @default(false)
  seoTitle          String?           @map("seo_title") @db.VarChar(255)
  seoDescription    String?           @map("seo_description") @db.VarChar(500)
  seoKeywords       String?           @map("seo_keywords") @db.VarChar(500)
  metadata          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  categoryId        String            @map("category_id") @db.Uuid
  subcategoryId     String?           @map("subcategory_id") @db.Uuid
  orderItems        OrderItem[]
  images            ProductImage[]
  templates         ProductTemplate[]
  variants          ProductVariant[]
  category          Category          @relation(fields: [categoryId], references: [id])
  subcategory       Subcategory?      @relation(fields: [subcategoryId], references: [id])
  wishlistItems     WishlistItem[]
  cartItems         CartItem[]

  @@index([slug])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([legacyCategory])
  @@index([legacyProductType])
  @@index([status])
  @@index([featured])
  @@index([legacyProductType], map: "products_product_type_idx")
  @@map("products")
}

model ProductVariant {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId  String         @map("product_id") @db.Uuid
  name       String         @db.VarChar(255)
  sku        String?        @unique @db.VarChar(100)
  size       String?        @db.VarChar(50)
  material   String?        @db.VarChar(100)
  color      String?        @db.VarChar(50)
  finish     String?        @db.VarChar(50)
  dimensions Json?
  price      Decimal        @db.Decimal(10, 2)
  stock      Int            @default(0)
  isDefault  Boolean        @default(false) @map("is_default")
  metadata   Json?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @default(now()) @updatedAt @map("updated_at")
  orderItems OrderItem[]
  images     ProductImage[]
  cartItems  CartItem[]
  product    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductImage {
  id           String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String          @map("product_id") @db.Uuid
  variantId    String?         @map("variant_id") @db.Uuid
  imageUrl     String          @map("image_url") @db.VarChar(500)
  altText      String?         @map("alt_text") @db.VarChar(255)
  displayOrder Int             @default(0) @map("display_order")
  isPrimary    Boolean         @default(false) @map("is_primary")
  createdAt    DateTime        @default(now()) @map("created_at")
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([displayOrder])
  @@map("product_images")
}

model ProductTemplate {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String   @map("product_id") @db.Uuid
  name          String   @db.VarChar(255)
  description   String?
  thumbnailUrl  String   @map("thumbnail_url") @db.VarChar(500)
  designFileUrl String   @map("design_file_url") @db.VarChar(500)
  category      String?  @db.VarChar(100)
  tags          Json?
  isPremium     Boolean  @default(false) @map("is_premium")
  price         Decimal? @db.Decimal(10, 2)
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([category])
  @@index([isPremium])
  @@map("product_templates")
}

model OrderItem {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String          @map("order_id") @db.Uuid
  productId     String?         @map("product_id") @db.Uuid
  variantId     String?         @map("variant_id") @db.Uuid
  designId      String?         @map("design_id") @db.Uuid
  quantity      Int             @default(1)
  unitPrice     Decimal         @map("unit_price") @db.Decimal(10, 2)
  totalPrice    Decimal         @map("total_price") @db.Decimal(10, 2)
  customization Json?
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  design        Design?         @relation(fields: [designId], references: [id])
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?        @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  // Issue relation (one issue max per item)
  issue         Issue?

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@index([designId])
  @@map("order_items")
}

model Order {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId       String           @map("customer_id") @db.Uuid
  designId         String?          @map("design_id") @db.Uuid
  status           OrderStatus      @default(pending)
  printSize        PrintSize?       @map("print_size")
  material         Material?
  orientation      Orientation?
  printWidth       Int?             @map("print_width")
  printHeight      Int?             @map("print_height")
  previewUrl       String?          @map("preview_url") @db.VarChar(500)
  subtotal         Decimal?         @db.Decimal(10, 2)
  discountAmount   Decimal?         @map("discount_amount") @db.Decimal(10, 2)
  promoCode        String?          @map("promo_code") @db.VarChar(50)
  totalPrice       Decimal          @map("total_price") @db.Decimal(10, 2)
  shippingAddress  Json             @map("shipping_address")
  royalmailOrderId String?          @map("royalmail_order_id") @db.VarChar(255)
  trackingNumber   String?          @map("tracking_number") @db.VarChar(255)
  carrier          String?          @db.VarChar(50)
  shareToken       String?          @unique @map("share_token") @db.VarChar(32)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @default(now()) @updatedAt @map("updated_at")

  // Cancellation fields
  cancelledAt          DateTime?           @map("cancelled_at")
  cancelledBy          CancelledBy?        @map("cancelled_by")
  cancellationReason   CancellationReason? @map("cancellation_reason")
  cancellationNotes    String?             @map("cancellation_notes")
  stripeRefundId       String?             @map("stripe_refund_id") @db.VarChar(255)
  refundAmount         Decimal?            @map("refund_amount") @db.Decimal(10, 2)

  // Relations
  inventoryUsages      InventoryUsage[]
  invoice              Invoice?
  items                OrderItem[]
  customer             User             @relation(fields: [customerId], references: [id])
  design               Design?          @relation(fields: [designId], references: [id])
  payment              Payment?
  resolutions          Resolution[]
  review               Review?
  cancellationRequest  CancellationRequest?
  incomes              Income[]         // Auto-accounting relation (can have multiple: sale + refund)

  @@index([customerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([trackingNumber])
  @@index([promoCode])
  @@index([shareToken])
  @@map("orders")
}

// ============================================
// CANCELLATION REQUEST SYSTEM
// For buyer-initiated cancellation requests that need admin approval
// ============================================

model CancellationRequest {
  id            String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String                    @unique @map("order_id") @db.Uuid
  order         Order                     @relation(fields: [orderId], references: [id])

  // Request details
  reason        CancellationReason
  notes         String?

  // Previous order status (to restore if rejected)
  // Default to 'confirmed' for existing records during migration
  previousStatus OrderStatus              @default(confirmed) @map("previous_status")

  // Status tracking
  status        CancellationRequestStatus @default(PENDING)
  createdAt     DateTime                  @default(now()) @map("created_at")

  // Review information
  reviewedAt    DateTime?                 @map("reviewed_at")
  reviewedBy    String?                   @map("reviewed_by") @db.Uuid
  reviewNotes   String?                   @map("review_notes")

  @@index([orderId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("cancellation_requests")
}

model Review {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String   @unique @map("order_id") @db.Uuid
  reviewerId String   @map("reviewer_id") @db.Uuid
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  order      Order    @relation(fields: [orderId], references: [id])
  reviewer   User     @relation(fields: [reviewerId], references: [id])

  @@index([orderId])
  @@index([rating])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

model UserPreference {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @unique @map("user_id") @db.Uuid
  preferences Json?
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_preferences")
}

model WishlistItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([createdAt(sort: Desc)])
  @@map("wishlist_items")
}

model CartItem {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String          @map("user_id") @db.Uuid
  productId     String          @map("product_id") @db.Uuid
  variantId     String?         @map("variant_id") @db.Uuid
  quantity      Int             @default(1)
  unitPrice     Decimal         @map("unit_price") @db.Decimal(10, 2)
  customization Json?
  addedAt       DateTime        @default(now()) @map("added_at")
  updatedAt     DateTime        @default(now()) @updatedAt @map("updated_at")

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant       ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([addedAt(sort: Desc)])
  @@map("cart_items")
}

model RecoveryCampaign {
  id                String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String                 @map("user_id") @db.Uuid
  type              RecoveryType
  status            RecoveryCampaignStatus @default(PENDING)

  triggerItemCount  Int                    @map("trigger_item_count")
  triggerTotalValue Decimal?               @map("trigger_total_value") @db.Decimal(10, 2)
  oldestItemDate    DateTime               @map("oldest_item_date")

  promoId           String?                @unique @map("promo_id") @db.Uuid
  promoCode         String?                @map("promo_code") @db.VarChar(50)

  emailSentAt       DateTime?              @map("email_sent_at")
  convertedOrderId  String?                @map("converted_order_id") @db.Uuid
  convertedAt       DateTime?              @map("converted_at")
  recoveredRevenue  Decimal?               @map("recovered_revenue") @db.Decimal(10, 2)

  createdAt         DateTime               @default(now()) @map("created_at")
  expiresAt         DateTime               @map("expires_at")

  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  promo             Promo?                 @relation(fields: [promoId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([emailSentAt(sort: Desc)])
  @@map("recovery_campaigns")
}

model Invoice {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber String        @unique @map("invoice_number") @db.VarChar(50)
  orderId       String        @unique @map("order_id") @db.Uuid
  subtotal      Decimal       @db.Decimal(10, 2)
  vatRate       Decimal       @map("vat_rate") @db.Decimal(5, 2)
  vatAmount     Decimal       @map("vat_amount") @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  currency      String        @default("GBP") @db.VarChar(3)
  exchangeRate  Decimal?      @map("exchange_rate") @db.Decimal(10, 4)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime      @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  pdfUrl        String?       @map("pdf_url") @db.VarChar(500)
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at")
  order         Order         @relation(fields: [orderId], references: [id])

  @@index([invoiceNumber])
  @@index([status])
  @@index([issueDate(sort: Desc)])
  @@map("invoices")
}

model Payment {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId             String        @unique @map("order_id") @db.Uuid
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("GBP") @db.VarChar(3)
  paymentMethod       PaymentMethod @map("payment_method")
  status              PaymentStatus @default(PENDING)
  stripePaymentId     String?       @map("stripe_payment_id") @db.VarChar(255)
  paypalTransactionId String?       @map("paypal_transaction_id") @db.VarChar(255)
  gatewayResponse     Json?         @map("gateway_response")
  paidAt              DateTime?     @map("paid_at")
  refundedAt          DateTime?     @map("refunded_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at")
  order               Order         @relation(fields: [orderId], references: [id])

  @@index([status])
  @@index([paymentMethod])
  @@index([paidAt(sort: Desc)])
  @@map("payments")
}

model Expense {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseNumber      String              @unique @map("expense_number") @db.VarChar(50)
  category           ExpenseCategory
  description        String              @db.VarChar(500)
  amount             Decimal             @db.Decimal(10, 2)
  currency           String              @default("GBP") @db.VarChar(3)
  exchangeRate       Decimal?            @map("exchange_rate") @db.Decimal(10, 4)
  supplierId         String?             @map("supplier_id") @db.Uuid
  receiptUrl         String?             @map("receipt_url") @db.VarChar(500)
  searchMetadata     Json?               @map("search_metadata")
  purchaseDate       DateTime            @default(now()) @map("purchase_date")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at")
  notes              String?

  // VAT tracking for expense deductions
  vatAmount          Decimal?            @map("vat_amount") @db.Decimal(10, 2)
  vatRate            Decimal?            @map("vat_rate") @db.Decimal(5, 2)
  isVatReclaimable   Boolean             @default(false) @map("is_vat_reclaimable")

  // Import source tracking
  importSource       ExpenseImportSource @default(MANUAL) @map("import_source")
  importBatchId      String?             @map("import_batch_id") @db.Uuid
  externalReference  String?             @map("external_reference") @db.VarChar(255)

  // Tax year tracking
  taxYear            String?             @map("tax_year") @db.VarChar(9)

  supplier              Supplier?            @relation(fields: [supplierId], references: [id])
  importBatch           ExpenseImportBatch?  @relation(fields: [importBatchId], references: [id])
  inventoryAdditions    InventoryAddition[]
  supplierTransaction   SupplierTransaction? // Auto-linked from Stripe Issuing
  wiseTransaction       WiseTransaction?     // Auto-linked from Wise

  @@index([category])
  @@index([supplierId])
  @@index([purchaseDate(sort: Desc)])
  @@index([taxYear])
  @@index([importBatchId])
  @@map("expenses")
}

// ============================================
// STRIPE ISSUING - VIRTUAL CARDS FOR PURCHASING
// ============================================

model VirtualCard {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  stripeCardId    String        @unique @map("stripe_card_id") @db.VarChar(255)
  cardholderId    String        @map("cardholder_id") @db.VarChar(255)
  name            String        @db.VarChar(100) // Card nickname
  last4           String        @db.VarChar(4)
  expiryMonth     Int           @map("expiry_month")
  expiryYear      Int           @map("expiry_year")
  spendingLimit   Decimal       @map("spending_limit") @db.Decimal(10, 2)
  status          CardStatus    @default(ACTIVE)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at")
  createdBy       String        @map("created_by") @db.Uuid // Admin user ID

  transactions    SupplierTransaction[]

  @@index([status])
  @@index([createdBy])
  @@map("virtual_cards")
}

model SupplierTransaction {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId            String            @map("card_id") @db.Uuid
  stripeAuthId      String            @unique @map("stripe_auth_id") @db.VarChar(255)
  merchantName      String            @map("merchant_name") @db.VarChar(255)
  merchantCategory  String?           @map("merchant_category") @db.VarChar(100)
  amount            Decimal           @db.Decimal(10, 2)
  currency          String            @default("GBP") @db.VarChar(3)
  status            TransactionStatus @default(PENDING)
  productSearched   Json?             @map("product_searched") // Original search result
  expenseId         String?           @unique @map("expense_id") @db.Uuid
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")

  card              VirtualCard       @relation(fields: [cardId], references: [id])
  expense           Expense?          @relation(fields: [expenseId], references: [id])

  @@index([cardId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("supplier_transactions")
}

model SavedProduct {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source          String   @db.VarChar(50) // amazon, ebay, aliexpress, google
  externalId      String   @map("external_id") @db.VarChar(255)
  title           String   @db.VarChar(500)
  price           Decimal  @db.Decimal(10, 2)
  currency        String   @default("GBP") @db.VarChar(3)
  imageUrl        String?  @map("image_url") @db.VarChar(500)
  productUrl      String   @map("product_url") @db.VarChar(1000)
  sellerName      String?  @map("seller_name") @db.VarChar(255)
  sellerRating    Decimal? @map("seller_rating") @db.Decimal(3, 2)
  metadata        Json?    // Additional product info
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String   @map("created_by") @db.Uuid // Admin user ID

  @@unique([source, externalId])
  @@index([source])
  @@index([createdBy])
  @@map("saved_products")
}

// ============================================
// WISE INTEGRATION - AUTOMATIC EXPENSE CAPTURE
// ============================================

model WiseAccount {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId       String            @unique @map("profile_id") @db.VarChar(50) // Wise profile ID
  profileType     WiseProfileType   @map("profile_type") // personal or business
  name            String            @db.VarChar(255)
  email           String?           @db.VarChar(255)

  // API credentials (encrypted in practice)
  apiToken        String?           @map("api_token") @db.VarChar(500)

  // Sync configuration
  isActive        Boolean           @default(true) @map("is_active")
  lastSyncAt      DateTime?         @map("last_sync_at")
  syncFrequency   Int               @default(5) @map("sync_frequency") // minutes
  autoCreateExpense Boolean         @default(true) @map("auto_create_expense")

  // Webhook configuration (for business accounts)
  webhookSecret   String?           @map("webhook_secret") @db.VarChar(255)
  webhookEnabled  Boolean           @default(false) @map("webhook_enabled")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at")
  createdBy       String            @map("created_by") @db.Uuid

  transactions    WiseTransaction[]
  balances        WiseBalance[]

  @@index([isActive])
  @@index([createdBy])
  @@map("wise_accounts")
}

model WiseBalance {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId       String       @map("account_id") @db.Uuid
  currency        String       @db.VarChar(3)
  amount          Decimal      @db.Decimal(15, 2)
  reservedAmount  Decimal      @default(0) @map("reserved_amount") @db.Decimal(15, 2)
  lastUpdated     DateTime     @default(now()) @map("last_updated")

  account         WiseAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, currency])
  @@index([accountId])
  @@map("wise_balances")
}

model WiseTransaction {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId           String                @map("account_id") @db.Uuid
  wiseTransactionId   String                @unique @map("wise_transaction_id") @db.VarChar(50)

  // Transaction details
  type                WiseTransactionType
  status              WiseTransactionStatus @default(PENDING)
  direction           TransactionDirection  @default(OUTGOING)

  // Amount info
  amount              Decimal               @db.Decimal(15, 2)
  currency            String                @db.VarChar(3)
  amountInGBP         Decimal?              @map("amount_in_gbp") @db.Decimal(15, 2) // Converted for reporting
  exchangeRate        Decimal?              @map("exchange_rate") @db.Decimal(15, 6)
  fee                 Decimal?              @db.Decimal(10, 2)

  // Merchant/recipient info
  merchantName        String?               @map("merchant_name") @db.VarChar(255)
  merchantCategory    String?               @map("merchant_category") @db.VarChar(100)
  merchantCategoryCode String?              @map("merchant_category_code") @db.VarChar(10) // MCC code
  description         String?               @db.VarChar(500)

  // Card details (if card transaction)
  cardLast4           String?               @map("card_last_4") @db.VarChar(4)
  cardId              String?               @map("card_id") @db.VarChar(50)

  // Reference to auto-created expense
  expenseId           String?               @unique @map("expense_id") @db.Uuid

  // Raw data from Wise API
  rawData             Json?                 @map("raw_data")

  // Timestamps
  transactionDate     DateTime              @map("transaction_date")
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @default(now()) @updatedAt @map("updated_at")

  account             WiseAccount           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expense             Expense?              @relation(fields: [expenseId], references: [id])

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([transactionDate(sort: Desc)])
  @@index([merchantName])
  @@map("wise_transactions")
}

enum WiseProfileType {
  PERSONAL
  BUSINESS
}

enum WiseTransactionType {
  CARD_PAYMENT       // Debit card purchase
  CARD_REFUND        // Refund to card
  TRANSFER_OUT       // Transfer sent
  TRANSFER_IN        // Transfer received
  CONVERSION         // Currency conversion
  DIRECT_DEBIT       // Direct debit payment
  ATM_WITHDRAWAL     // Cash withdrawal
  FEE                // Wise fees
  OTHER
}

enum WiseTransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
  REFUNDED
}

enum TransactionDirection {
  INCOMING
  OUTGOING
}

model Income {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  incomeNumber       String              @unique @map("income_number") @db.VarChar(50)
  category           IncomeCategory
  description        String              @db.VarChar(500)
  amount             Decimal             @db.Decimal(10, 2)
  currency           String              @default("GBP") @db.VarChar(3)
  source             String?             @db.VarChar(255) // e.g., "Market Stall", "Wholesale", "Etsy", etc.
  customerName       String?             @map("customer_name") @db.VarChar(255)
  receiptUrl         String?             @map("receipt_url") @db.VarChar(500)
  incomeDate         DateTime            @default(now()) @map("income_date")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at")
  notes              String?

  // VAT tracking
  vatAmount          Decimal?            @map("vat_amount") @db.Decimal(10, 2)
  vatRate            Decimal?            @map("vat_rate") @db.Decimal(5, 2)
  isVatIncluded      Boolean             @default(true) @map("is_vat_included")

  // Reference tracking
  externalReference  String?             @map("external_reference") @db.VarChar(255) // Invoice number, receipt number, etc.

  // Tax year tracking
  taxYear            String?             @map("tax_year") @db.VarChar(9)

  // Order linking for auto-accounting (not unique - allows refund entries for same order)
  orderId            String?             @map("order_id") @db.Uuid
  status             IncomeStatus        @default(PENDING)
  order              Order?              @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([category])
  @@index([source])
  @@index([incomeDate(sort: Desc)])
  @@index([taxYear])
  @@index([status])
  @@map("income")
}

model Supplier {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar(255)
  contactInfo Json?     @map("contact_info")
  website     String?   @db.VarChar(500)
  rating      Decimal?  @db.Decimal(3, 2)
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  expenses    Expense[]

  @@index([name])
  @@map("suppliers")
}

model Inventory {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  itemName        String              @map("item_name") @db.VarChar(255)
  category        ExpenseCategory
  description     String?
  currentStock    Int                 @default(0) @map("current_stock")
  unit            String              @db.VarChar(50)
  reorderPoint    Int?                @map("reorder_point")
  reorderQuantity Int?                @map("reorder_quantity")
  unitCost        Decimal?            @map("unit_cost") @db.Decimal(10, 2)
  currency        String              @default("GBP") @db.VarChar(3)
  sku             String?             @unique @db.VarChar(100)
  metadata        Json?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @default(now()) @updatedAt @map("updated_at")
  additions       InventoryAddition[]
  usages          InventoryUsage[]

  @@index([itemName])
  @@index([category])
  @@index([currentStock])
  @@map("inventory")
}

model InventoryAddition {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String    @map("inventory_id") @db.Uuid
  expenseId   String?   @map("expense_id") @db.Uuid
  quantity    Int
  unitCost    Decimal?  @map("unit_cost") @db.Decimal(10, 2)
  notes       String?
  addedAt     DateTime  @default(now()) @map("added_at")
  expense     Expense?  @relation(fields: [expenseId], references: [id])
  inventory   Inventory @relation(fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([expenseId])
  @@index([addedAt(sort: Desc)])
  @@map("inventory_additions")
}

model InventoryUsage {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String    @map("inventory_id") @db.Uuid
  orderId     String?   @map("order_id") @db.Uuid
  quantity    Int
  notes       String?
  usedAt      DateTime  @default(now()) @map("used_at")
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  order       Order?    @relation(fields: [orderId], references: [id])

  @@index([inventoryId])
  @@index([orderId])
  @@index([usedAt(sort: Desc)])
  @@map("inventory_usages")
}

model FinancialReport {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  period        ReportPeriod
  startDate     DateTime     @map("start_date")
  endDate       DateTime     @map("end_date")
  totalRevenue  Decimal      @map("total_revenue") @db.Decimal(10, 2)
  totalExpenses Decimal      @map("total_expenses") @db.Decimal(10, 2)
  netProfit     Decimal      @map("net_profit") @db.Decimal(10, 2)
  vatCollected  Decimal      @map("vat_collected") @db.Decimal(10, 2)
  orderCount    Int          @map("order_count")
  reportData    Json         @map("report_data")
  pdfUrl        String?      @map("pdf_url") @db.VarChar(500)
  createdAt     DateTime     @default(now()) @map("created_at")

  // Enhanced UK tax compliance fields
  vatReclaimable     Decimal?            @map("vat_reclaimable") @db.Decimal(10, 2)
  costOfGoodsSold    Decimal?            @map("cost_of_goods_sold") @db.Decimal(10, 2)
  grossProfit        Decimal?            @map("gross_profit") @db.Decimal(10, 2)
  expensesByCategory Json?               @map("expenses_by_category")
  reportType         FinancialReportType @default(SUMMARY) @map("report_type")
  taxYear            String?             @map("tax_year") @db.VarChar(9)

  @@index([period])
  @@index([startDate, endDate])
  @@index([createdAt(sort: Desc)])
  @@index([reportType])
  @@index([taxYear])
  @@map("financial_reports")
}

model ExpenseImportBatch {
  id           String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source       ExpenseImportSource
  fileName     String?             @map("file_name") @db.VarChar(255)
  recordCount  Int                 @map("record_count")
  successCount Int                 @default(0) @map("success_count")
  errorCount   Int                 @default(0) @map("error_count")
  errors       Json?
  status       ImportBatchStatus   @default(PENDING)
  importedBy   String              @map("imported_by") @db.Uuid
  createdAt    DateTime            @default(now()) @map("created_at")
  completedAt  DateTime?           @map("completed_at")

  expenses     Expense[]

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("expense_import_batches")
}

model WeeklyEmailReport {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  weekStartDate DateTime @map("week_start_date")
  weekEndDate   DateTime @map("week_end_date")
  emailSentTo   String   @map("email_sent_to") @db.VarChar(255)
  emailSentAt   DateTime @map("email_sent_at")
  reportData    Json     @map("report_data")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([weekStartDate, weekEndDate])
  @@index([weekStartDate(sort: Desc)])
  @@map("weekly_email_reports")
}

enum UserType {
  customer
  admin
}

enum OrderStatus {
  pending
  payment_confirmed
  confirmed
  printing
  shipped
  delivered
  cancellation_requested
  cancelled
  refunded
}

enum CancelledBy {
  ADMIN
  CUSTOMER
}

enum CancellationReason {
  OUT_OF_STOCK
  BUYER_REQUEST
  FRAUD_SUSPECTED
  PAYMENT_ISSUE
  PRODUCTION_ISSUE
  DUPLICATE_ORDER
  OTHER
}

enum CancellationRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PrintSize {
  A4
  A3
  A5
  SQUARE_20CM
  SQUARE_30CM
  CUSTOM
}

enum Material {
  MATTE
  GLOSSY
  CANVAS
  FINE_ART
}

enum Orientation {
  PORTRAIT
  LANDSCAPE
  SQUARE
}

enum ProductCategory {
  HOME_LIFESTYLE
  STATIONERY
  LARGE_FORMAT
  PHOTO_PRINTS
  DIGITAL
  CUSTOM_ORDER
}

enum ProductType {
  TSHIRT
  MUG
  WATER_BOTTLE
  MOUSEMAT
  KEYCHAIN
  CUSHION_PILLOW
  BUSINESS_CARD
  LEAFLET
  GREETING_CARD
  POSTCARD
  BANNER
  POSTER
  CANVAS_PRINT
  ALUMINUM_PRINT
  PHOTO_PAPER_PRINT
  ACRYLIC_LED_PRINT
  DIGITAL_PDF
}

enum CustomizationType {
  TEMPLATE_BASED
  UPLOAD_OWN
  FULLY_CUSTOM
  DIGITAL_DOWNLOAD
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  CARD
  BANK_TRANSFER
  CASH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  MATERIALS
  PACKAGING
  SHIPPING_SUPPLIES
  EQUIPMENT
  SOFTWARE
  UTILITIES
  MARKETING
  OTHER
}

enum IncomeCategory {
  PRODUCT_SALES
  WHOLESALE
  MARKET_SALES
  ONLINE_MARKETPLACE
  CUSTOM_ORDERS
  SHIPPING_REIMBURSEMENT
  REFUND_RECEIVED
  OTHER
}

enum IncomeStatus {
  PENDING    // Payment received, order not yet delivered
  CONFIRMED  // Order delivered, income confirmed
  REVERSED   // Refunded or cancelled
}

enum CardStatus {
  ACTIVE
  FROZEN
  CANCELLED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  DECLINED
  REFUNDED
}

enum ReportPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ExpenseImportSource {
  MANUAL
  CSV_IMPORT
  AMAZON_API
  EBAY_API
  SUPPLIER_INTEGRATION
  WISE_API
}

enum ImportBatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum FinancialReportType {
  SUMMARY
  PROFIT_LOSS
  VAT_RETURN
  TAX_YEAR_END
}

// ============================================
// EMAIL SUBSCRIBER SYSTEM
// ============================================

model Subscriber {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String           @unique @db.VarChar(255)
  name           String?          @db.VarChar(255)
  status         SubscriberStatus @default(PENDING)
  source         SubscriberSource @default(FOOTER)
  confirmToken   String?          @map("confirm_token") @db.VarChar(255)
  subscribedAt   DateTime?        @map("subscribed_at")
  unsubscribedAt DateTime?        @map("unsubscribed_at")

  // Bounce tracking
  bounceCount    Int              @default(0) @map("bounce_count")
  lastBounceAt   DateTime?        @map("last_bounce_at")
  bounceType     String?          @map("bounce_type") @db.VarChar(50) // hard, soft, complaint

  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @default(now()) @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("subscribers")
}

enum SubscriberStatus {
  PENDING      // Awaiting email confirmation
  ACTIVE       // Confirmed and receiving emails
  UNSUBSCRIBED // User unsubscribed
  BOUNCED      // Email bounced - do not send
}

enum SubscriberSource {
  FOOTER
  CHECKOUT
  POPUP
  ADMIN      // Manually added by admin
}

// ============================================
// PROMO/DISCOUNT SYSTEM
// ============================================

model Promo {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String      @unique @db.VarChar(50)
  name            String      @db.VarChar(255)
  description     String?

  // Discount configuration
  discountType    DiscountType @map("discount_type")
  discountValue   Decimal      @map("discount_value") @db.Decimal(10, 2) // Percentage (0-100) or fixed amount

  // Scope: what the promo applies to
  scope           PromoScope   @default(ALL_PRODUCTS)
  categoryId      String?      @map("category_id") @db.Uuid
  subcategoryId   String?      @map("subcategory_id") @db.Uuid
  productIds      String[]     @map("product_ids") @db.Uuid // For specific products

  // Validity period
  startsAt        DateTime?    @map("starts_at")
  expiresAt       DateTime?    @map("expires_at")

  // Usage limits
  maxUses         Int?         @map("max_uses")         // Total uses allowed (null = unlimited)
  maxUsesPerUser  Int          @default(1) @map("max_uses_per_user") // Uses per customer (default 1)
  currentUses     Int          @default(0) @map("current_uses")

  // Requirements
  minOrderAmount  Decimal?     @map("min_order_amount") @db.Decimal(10, 2)

  // Status
  isActive        Boolean      @default(true) @map("is_active")

  // Metadata
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @default(now()) @updatedAt @map("updated_at")

  // Relations
  usages            PromoUsage[]
  recoveryCampaign  RecoveryCampaign?
  isRecoveryPromo   Boolean            @default(false) @map("is_recovery_promo")

  @@index([code])
  @@index([isActive])
  @@index([startsAt])
  @@index([expiresAt])
  @@index([scope])
  @@map("promos")
}

model PromoUsage {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  promoId     String   @map("promo_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid  // Can be null for guest checkout
  orderId     String?  @map("order_id") @db.Uuid
  email       String?  @db.VarChar(255)          // Track by email for guests

  // Amount saved
  discountAmount Decimal @map("discount_amount") @db.Decimal(10, 2)

  usedAt      DateTime @default(now()) @map("used_at")

  promo       Promo    @relation(fields: [promoId], references: [id], onDelete: Cascade)

  @@index([promoId])
  @@index([userId])
  @@index([email])
  @@index([orderId])
  @@index([usedAt(sort: Desc)])
  @@map("promo_usages")
}

enum DiscountType {
  PERCENTAGE    // e.g., 10% off
  FIXED_AMOUNT  // e.g., Â£5 off
}

enum PromoScope {
  ALL_PRODUCTS      // Applies to entire order
  CATEGORY          // Applies to specific category
  SUBCATEGORY       // Applies to specific subcategory
  SPECIFIC_PRODUCTS // Applies to specific product IDs
}

enum RecoveryType {
  CART
  WISHLIST
}

enum RecoveryCampaignStatus {
  PENDING
  SENT
  CONVERTED
  EXPIRED
  CANCELLED
}

// ============================================
// EMAIL CAMPAIGN SYSTEM
// ============================================

model EmailCampaign {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String         @db.VarChar(255)
  subject       String         @db.VarChar(255)
  previewText   String?        @map("preview_text") @db.VarChar(255)
  content       String         // HTML content
  plainText     String?        @map("plain_text") // Plain text version

  // Campaign type and targeting
  type          CampaignType   @default(NEWSLETTER)
  promoId       String?        @map("promo_id") @db.Uuid // Link to a promo if announcing one

  // Status and scheduling
  status        CampaignStatus @default(DRAFT)
  scheduledAt   DateTime?      @map("scheduled_at")
  sentAt        DateTime?      @map("sent_at")

  // Recurring schedule (for weekly newsletters)
  isRecurring   Boolean        @default(false) @map("is_recurring")
  recurrenceDay Int?           @map("recurrence_day") // 0=Sunday, 1=Monday, ..., 6=Saturday
  recurrenceTime String?       @map("recurrence_time") @db.VarChar(5) // HH:MM format
  lastSentWeek  Int?           @map("last_sent_week") // ISO week number to prevent double-send

  // Stats
  recipientCount Int           @default(0) @map("recipient_count")
  sentCount      Int           @default(0) @map("sent_count")
  failedCount    Int           @default(0) @map("failed_count")
  openCount      Int           @default(0) @map("open_count")
  clickCount     Int           @default(0) @map("click_count")
  bounceCount    Int           @default(0) @map("bounce_count")
  unsubscribeCount Int         @default(0) @map("unsubscribe_count")

  // Metadata
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at")

  @@index([status])
  @@index([scheduledAt])
  @@index([sentAt(sort: Desc)])
  @@map("email_campaigns")
}

enum CampaignType {
  NEWSLETTER    // General newsletter
  PROMO         // Promotional campaign with promo code
  ANNOUNCEMENT  // Product/feature announcement
  SEASONAL      // Seasonal/holiday campaign
}

enum CampaignStatus {
  DRAFT         // Being edited
  SCHEDULED     // Scheduled for future send
  SENDING       // Currently being sent
  SENT          // Completed
  FAILED        // Failed to send
  CANCELLED     // Cancelled before send
}

// ============================================
// RETURNS & RESOLUTIONS SYSTEM (LEGACY - kept for migration)
// ============================================

model Resolution {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String           @map("order_id") @db.Uuid
  order          Order            @relation(fields: [orderId], references: [id])
  type           ResolutionType
  reason         ResolutionReason
  notes          String?
  imageUrls      Json?            @map("image_urls") // Array of image URLs uploaded by customer

  // For reprints - link to the new order created
  reprintOrderId String?          @map("reprint_order_id") @db.Uuid

  // For refunds
  refundAmount   Decimal?         @map("refund_amount") @db.Decimal(10, 2)
  stripeRefundId String?          @map("stripe_refund_id") @db.VarChar(255)

  // Status tracking
  status         ResolutionStatus @default(PENDING)
  createdBy      String           @map("created_by") @db.Uuid  // User who created (customer or admin)
  createdAt      DateTime         @default(now()) @map("created_at")
  processedAt    DateTime?        @map("processed_at")

  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("resolutions")
}

enum ResolutionType {
  REPRINT
  REFUND
}

enum ResolutionReason {
  DAMAGED_IN_TRANSIT
  QUALITY_ISSUE
  WRONG_ITEM
  PRINTING_ERROR
  OTHER
}

enum ResolutionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// ENHANCED ISSUE SYSTEM (per-item with correspondence)
// ============================================

model Issue {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderItemId     String           @unique @map("order_item_id") @db.Uuid
  orderItem       OrderItem        @relation(fields: [orderItemId], references: [id])

  // Issue details
  reason          IssueReason
  status          IssueStatus      @default(SUBMITTED)
  carrierFault    CarrierFault     @default(UNKNOWN) @map("carrier_fault")

  // Customer-provided evidence
  initialNotes    String?          @map("initial_notes")
  imageUrls       Json?            @map("image_urls") // String[]

  // Resolution tracking
  resolvedType    IssueResolutionType? @map("resolved_type")
  reprintOrderId  String?          @map("reprint_order_id") @db.Uuid
  reprintItemId   String?          @map("reprint_item_id") @db.Uuid
  refundAmount    Decimal?         @map("refund_amount") @db.Decimal(10, 2)
  stripeRefundId  String?          @map("stripe_refund_id") @db.VarChar(255)

  // Reprint chain tracking (for reprints of reprints)
  originalIssueId String?          @map("original_issue_id") @db.Uuid
  originalIssue   Issue?           @relation("IssueChain", fields: [originalIssueId], references: [id])
  childIssues     Issue[]          @relation("IssueChain")

  // Rejection tracking
  rejectionReason String?          @map("rejection_reason")
  rejectionFinal  Boolean          @default(false) @map("rejection_final")

  // Carrier claim tracking (for Royal Mail insurance claims)
  claimReference    String?        @map("claim_reference") @db.VarChar(100)
  claimStatus       ClaimStatus    @default(NOT_FILED) @map("claim_status")
  claimSubmittedAt  DateTime?      @map("claim_submitted_at")
  claimPayoutAmount Decimal?       @map("claim_payout_amount") @db.Decimal(10, 2)
  claimPaidAt       DateTime?      @map("claim_paid_at")
  claimNotes        String?        @map("claim_notes")

  // Timestamps
  createdBy       String           @map("created_by") @db.Uuid
  createdAt       DateTime         @default(now()) @map("created_at")
  reviewedAt      DateTime?        @map("reviewed_at")
  processedAt     DateTime?        @map("processed_at")
  closedAt        DateTime?        @map("closed_at")

  // Conclusion tracking (prevents further customer actions)
  isConcluded     Boolean          @default(false) @map("is_concluded")
  concludedAt     DateTime?        @map("concluded_at")
  concludedBy     String?          @map("concluded_by") @db.Uuid
  concludedReason String?          @map("concluded_reason")

  // Correspondence
  messages        IssueMessage[]

  @@index([status])
  @@index([carrierFault])
  @@index([isConcluded])
  @@index([createdAt(sort: Desc)])
  @@map("issues")
}

model IssueMessage {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  issueId     String        @map("issue_id") @db.Uuid
  issue       Issue         @relation(fields: [issueId], references: [id], onDelete: Cascade)

  sender      MessageSender
  senderId    String        @map("sender_id") @db.Uuid
  content     String
  imageUrls   Json?         @map("image_urls") // String[]

  // Email notification tracking
  emailSent   Boolean       @default(false) @map("email_sent")
  emailSentAt DateTime?     @map("email_sent_at")
  readAt      DateTime?     @map("read_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([issueId])
  @@index([createdAt(sort: Desc)])
  @@map("issue_messages")
}

// Enhanced Issue Status - reflects full lifecycle
enum IssueStatus {
  SUBMITTED           // Customer just submitted issue
  AWAITING_REVIEW     // Ready for admin review
  INFO_REQUESTED      // Admin requested more information
  APPROVED_REPRINT    // Admin approved for reprint
  APPROVED_REFUND     // Admin approved for refund
  PROCESSING          // Reprint/refund in progress
  COMPLETED           // Issue fully resolved
  REJECTED            // Admin rejected the issue
  CLOSED              // Final closure (after appeal or timeout)
}

// Who sent the message
enum MessageSender {
  CUSTOMER
  ADMIN
}

// Carrier fault determination
enum CarrierFault {
  UNKNOWN             // Not yet determined
  CARRIER_FAULT       // Carrier is at fault (for insurance claims)
  NOT_CARRIER_FAULT   // Not carrier's fault
}

// Carrier insurance claim status
enum ClaimStatus {
  NOT_FILED           // No claim filed yet
  SUBMITTED           // Claim submitted to carrier
  UNDER_REVIEW        // Carrier reviewing claim
  APPROVED            // Claim approved, awaiting payment
  REJECTED            // Claim rejected by carrier
  PAID                // Compensation received
}

// Issue reasons (enhanced from ResolutionReason)
enum IssueReason {
  DAMAGED_IN_TRANSIT  // Auto-flags carrier fault
  QUALITY_ISSUE
  WRONG_ITEM
  PRINTING_ERROR
  NEVER_ARRIVED       // Different from damaged - item never received
  OTHER
}

// Resolution type for approved issues
enum IssueResolutionType {
  REPRINT
  FULL_REFUND
  PARTIAL_REFUND
}

// ============================================
// AUDIT TRAIL SYSTEM
// Tracks critical operations for accountability
// ============================================

model AuditLog {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // What happened
  action          AuditAction
  entityType      AuditEntityType @map("entity_type")
  entityId        String          @map("entity_id") @db.Uuid

  // Who did it
  actorId         String?         @map("actor_id") @db.Uuid  // null for system actions
  actorType       ActorType       @map("actor_type")
  actorEmail      String?         @map("actor_email") @db.VarChar(255)

  // Details
  previousState   Json?           @map("previous_state")  // Snapshot before change
  newState        Json?           @map("new_state")       // Snapshot after change
  metadata        Json?                                   // Additional context
  ipAddress       String?         @map("ip_address") @db.VarChar(45)
  userAgent       String?         @map("user_agent") @db.VarChar(500)

  // Timestamp
  createdAt       DateTime        @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

enum AuditAction {
  // Order actions
  ORDER_CREATED
  ORDER_STATUS_CHANGED
  ORDER_CANCELLED
  ORDER_REFUNDED

  // Payment actions
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  REFUND_INITIATED
  REFUND_COMPLETED

  // Issue/Resolution actions
  ISSUE_CREATED
  ISSUE_REVIEWED
  ISSUE_RESOLVED
  ISSUE_REJECTED

  // Admin actions
  CANCELLATION_APPROVED
  CANCELLATION_REJECTED
  REPRINT_CREATED
  INVOICE_GENERATED

  // System actions
  WEBHOOK_PROCESSED
  STATUS_AUTO_UPDATED
}

enum AuditEntityType {
  ORDER
  PAYMENT
  ISSUE
  RESOLUTION
  CANCELLATION_REQUEST
  INVOICE
  INCOME
}

enum ActorType {
  CUSTOMER
  ADMIN
  SYSTEM      // Automated processes
  WEBHOOK     // External webhooks (e.g., Stripe)
}
