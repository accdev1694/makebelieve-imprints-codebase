generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                UserType
  email               String               @unique @db.VarChar(255)
  passwordHash        String               @map("password_hash") @db.VarChar(255)
  name                String               @db.VarChar(255)
  profile             Json?
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  designs             Design[]
  orders              Order[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  reviews             Review[]
  preferences         UserPreference?

  @@index([email])
  @@index([type])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Design {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  title       String?      @db.VarChar(255)
  fileUrl     String       @map("file_url") @db.VarChar(500)
  printSize   PrintSize?   @map("print_size")
  material    Material?
  orientation Orientation?
  printWidth  Int?         @map("print_width")
  printHeight Int?         @map("print_height")
  previewUrl  String?      @map("preview_url") @db.VarChar(500)
  metadata    Json?
  createdAt   DateTime     @default(now()) @map("created_at")
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  orders      Order[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("designs")
}

model Category {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String        @db.VarChar(255)
  slug          String        @unique @db.VarChar(255)
  description   String?
  image         String?       @db.VarChar(500)
  displayOrder  Int           @default(0) @map("display_order")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at")
  products      Product[]
  subcategories Subcategory[]

  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("categories")
}

model Subcategory {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId   String    @map("category_id") @db.Uuid
  name         String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  description  String?
  image        String?   @db.VarChar(500)
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")
  products     Product[]
  category     Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("subcategories")
}

model Product {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String            @db.VarChar(255)
  slug              String            @unique @db.VarChar(255)
  description       String
  legacyCategory    ProductCategory   @map("legacy_category")
  legacyProductType ProductType       @map("legacy_product_type")
  customizationType CustomizationType @map("customization_type")
  basePrice         Decimal           @map("base_price") @db.Decimal(10, 2)
  currency          String            @default("GBP") @db.VarChar(3)
  status            ProductStatus     @default(DRAFT)
  featured          Boolean           @default(false)
  seoTitle          String?           @map("seo_title") @db.VarChar(255)
  seoDescription    String?           @map("seo_description") @db.VarChar(500)
  seoKeywords       String?           @map("seo_keywords") @db.VarChar(500)
  metadata          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  categoryId        String            @map("category_id") @db.Uuid
  subcategoryId     String?           @map("subcategory_id") @db.Uuid
  orderItems        OrderItem[]
  images            ProductImage[]
  templates         ProductTemplate[]
  variants          ProductVariant[]
  category          Category          @relation(fields: [categoryId], references: [id])
  subcategory       Subcategory?      @relation(fields: [subcategoryId], references: [id])

  @@index([slug])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([legacyCategory])
  @@index([legacyProductType])
  @@index([status])
  @@index([featured])
  @@index([legacyProductType], map: "products_product_type_idx")
  @@map("products")
}

model ProductVariant {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId  String         @map("product_id") @db.Uuid
  name       String         @db.VarChar(255)
  sku        String?        @unique @db.VarChar(100)
  size       String?        @db.VarChar(50)
  material   String?        @db.VarChar(100)
  color      String?        @db.VarChar(50)
  finish     String?        @db.VarChar(50)
  dimensions Json?
  price      Decimal        @db.Decimal(10, 2)
  stock      Int            @default(0)
  isDefault  Boolean        @default(false) @map("is_default")
  metadata   Json?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @default(now()) @updatedAt @map("updated_at")
  orderItems OrderItem[]
  images     ProductImage[]
  product    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductImage {
  id           String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String          @map("product_id") @db.Uuid
  variantId    String?         @map("variant_id") @db.Uuid
  imageUrl     String          @map("image_url") @db.VarChar(500)
  altText      String?         @map("alt_text") @db.VarChar(255)
  displayOrder Int             @default(0) @map("display_order")
  isPrimary    Boolean         @default(false) @map("is_primary")
  createdAt    DateTime        @default(now()) @map("created_at")
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([displayOrder])
  @@map("product_images")
}

model ProductTemplate {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String   @map("product_id") @db.Uuid
  name          String   @db.VarChar(255)
  description   String?
  thumbnailUrl  String   @map("thumbnail_url") @db.VarChar(500)
  designFileUrl String   @map("design_file_url") @db.VarChar(500)
  category      String?  @db.VarChar(100)
  tags          Json?
  isPremium     Boolean  @default(false) @map("is_premium")
  price         Decimal? @db.Decimal(10, 2)
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([category])
  @@index([isPremium])
  @@map("product_templates")
}

model OrderItem {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String          @map("order_id") @db.Uuid
  productId     String?         @map("product_id") @db.Uuid
  variantId     String?         @map("variant_id") @db.Uuid
  designId      String?         @map("design_id") @db.Uuid
  quantity      Int             @default(1)
  unitPrice     Decimal         @map("unit_price") @db.Decimal(10, 2)
  totalPrice    Decimal         @map("total_price") @db.Decimal(10, 2)
  customization Json?
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")
  design        Design?         @relation(fields: [designId], references: [id])
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?        @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  // Issue relation (one issue max per item)
  issue         Issue?

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@index([designId])
  @@map("order_items")
}

model Order {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId       String           @map("customer_id") @db.Uuid
  designId         String?          @map("design_id") @db.Uuid
  status           OrderStatus      @default(pending)
  printSize        PrintSize?       @map("print_size")
  material         Material?
  orientation      Orientation?
  printWidth       Int?             @map("print_width")
  printHeight      Int?             @map("print_height")
  previewUrl       String?          @map("preview_url") @db.VarChar(500)
  subtotal         Decimal?         @db.Decimal(10, 2)
  discountAmount   Decimal?         @map("discount_amount") @db.Decimal(10, 2)
  promoCode        String?          @map("promo_code") @db.VarChar(50)
  totalPrice       Decimal          @map("total_price") @db.Decimal(10, 2)
  shippingAddress  Json             @map("shipping_address")
  royalmailOrderId String?          @map("royalmail_order_id") @db.VarChar(255)
  trackingNumber   String?          @map("tracking_number") @db.VarChar(255)
  carrier          String?          @db.VarChar(50)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @default(now()) @updatedAt @map("updated_at")
  inventoryUsages  InventoryUsage[]
  invoice          Invoice?
  items            OrderItem[]
  customer         User             @relation(fields: [customerId], references: [id])
  design           Design?          @relation(fields: [designId], references: [id])
  payment          Payment?
  resolutions      Resolution[]
  review           Review?

  @@index([customerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([trackingNumber])
  @@index([promoCode])
  @@map("orders")
}

model Review {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String   @unique @map("order_id") @db.Uuid
  reviewerId String   @map("reviewer_id") @db.Uuid
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  order      Order    @relation(fields: [orderId], references: [id])
  reviewer   User     @relation(fields: [reviewerId], references: [id])

  @@index([orderId])
  @@index([rating])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

model UserPreference {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @unique @map("user_id") @db.Uuid
  preferences Json?
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_preferences")
}

model Invoice {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber String        @unique @map("invoice_number") @db.VarChar(50)
  orderId       String        @unique @map("order_id") @db.Uuid
  subtotal      Decimal       @db.Decimal(10, 2)
  vatRate       Decimal       @map("vat_rate") @db.Decimal(5, 2)
  vatAmount     Decimal       @map("vat_amount") @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  currency      String        @default("GBP") @db.VarChar(3)
  exchangeRate  Decimal?      @map("exchange_rate") @db.Decimal(10, 4)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime      @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  pdfUrl        String?       @map("pdf_url") @db.VarChar(500)
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at")
  order         Order         @relation(fields: [orderId], references: [id])

  @@index([invoiceNumber])
  @@index([status])
  @@index([issueDate(sort: Desc)])
  @@map("invoices")
}

model Payment {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId             String        @unique @map("order_id") @db.Uuid
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("GBP") @db.VarChar(3)
  paymentMethod       PaymentMethod @map("payment_method")
  status              PaymentStatus @default(PENDING)
  stripePaymentId     String?       @map("stripe_payment_id") @db.VarChar(255)
  paypalTransactionId String?       @map("paypal_transaction_id") @db.VarChar(255)
  gatewayResponse     Json?         @map("gateway_response")
  paidAt              DateTime?     @map("paid_at")
  refundedAt          DateTime?     @map("refunded_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @default(now()) @updatedAt @map("updated_at")
  order               Order         @relation(fields: [orderId], references: [id])

  @@index([status])
  @@index([paymentMethod])
  @@index([paidAt(sort: Desc)])
  @@map("payments")
}

model Expense {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseNumber      String              @unique @map("expense_number") @db.VarChar(50)
  category           ExpenseCategory
  description        String              @db.VarChar(500)
  amount             Decimal             @db.Decimal(10, 2)
  currency           String              @default("GBP") @db.VarChar(3)
  exchangeRate       Decimal?            @map("exchange_rate") @db.Decimal(10, 4)
  supplierId         String?             @map("supplier_id") @db.Uuid
  receiptUrl         String?             @map("receipt_url") @db.VarChar(500)
  searchMetadata     Json?               @map("search_metadata")
  purchaseDate       DateTime            @default(now()) @map("purchase_date")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at")
  notes              String?
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  inventoryAdditions InventoryAddition[]

  @@index([category])
  @@index([supplierId])
  @@index([purchaseDate(sort: Desc)])
  @@map("expenses")
}

model Supplier {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar(255)
  contactInfo Json?     @map("contact_info")
  website     String?   @db.VarChar(500)
  rating      Decimal?  @db.Decimal(3, 2)
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  expenses    Expense[]

  @@index([name])
  @@map("suppliers")
}

model Inventory {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  itemName        String              @map("item_name") @db.VarChar(255)
  category        ExpenseCategory
  description     String?
  currentStock    Int                 @default(0) @map("current_stock")
  unit            String              @db.VarChar(50)
  reorderPoint    Int?                @map("reorder_point")
  reorderQuantity Int?                @map("reorder_quantity")
  unitCost        Decimal?            @map("unit_cost") @db.Decimal(10, 2)
  currency        String              @default("GBP") @db.VarChar(3)
  sku             String?             @unique @db.VarChar(100)
  metadata        Json?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @default(now()) @updatedAt @map("updated_at")
  additions       InventoryAddition[]
  usages          InventoryUsage[]

  @@index([itemName])
  @@index([category])
  @@index([currentStock])
  @@map("inventory")
}

model InventoryAddition {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String    @map("inventory_id") @db.Uuid
  expenseId   String?   @map("expense_id") @db.Uuid
  quantity    Int
  unitCost    Decimal?  @map("unit_cost") @db.Decimal(10, 2)
  notes       String?
  addedAt     DateTime  @default(now()) @map("added_at")
  expense     Expense?  @relation(fields: [expenseId], references: [id])
  inventory   Inventory @relation(fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([expenseId])
  @@index([addedAt(sort: Desc)])
  @@map("inventory_additions")
}

model InventoryUsage {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryId String    @map("inventory_id") @db.Uuid
  orderId     String?   @map("order_id") @db.Uuid
  quantity    Int
  notes       String?
  usedAt      DateTime  @default(now()) @map("used_at")
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  order       Order?    @relation(fields: [orderId], references: [id])

  @@index([inventoryId])
  @@index([orderId])
  @@index([usedAt(sort: Desc)])
  @@map("inventory_usages")
}

model FinancialReport {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  period        ReportPeriod
  startDate     DateTime     @map("start_date")
  endDate       DateTime     @map("end_date")
  totalRevenue  Decimal      @map("total_revenue") @db.Decimal(10, 2)
  totalExpenses Decimal      @map("total_expenses") @db.Decimal(10, 2)
  netProfit     Decimal      @map("net_profit") @db.Decimal(10, 2)
  vatCollected  Decimal      @map("vat_collected") @db.Decimal(10, 2)
  orderCount    Int          @map("order_count")
  reportData    Json         @map("report_data")
  pdfUrl        String?      @map("pdf_url") @db.VarChar(500)
  createdAt     DateTime     @default(now()) @map("created_at")

  @@index([period])
  @@index([startDate, endDate])
  @@index([createdAt(sort: Desc)])
  @@map("financial_reports")
}

enum UserType {
  customer
  admin
}

enum OrderStatus {
  pending
  confirmed
  printing
  shipped
  delivered
  cancelled
  refunded
}

enum PrintSize {
  A4
  A3
  A5
  SQUARE_20CM
  SQUARE_30CM
  CUSTOM
}

enum Material {
  MATTE
  GLOSSY
  CANVAS
  FINE_ART
}

enum Orientation {
  PORTRAIT
  LANDSCAPE
  SQUARE
}

enum ProductCategory {
  HOME_LIFESTYLE
  STATIONERY
  LARGE_FORMAT
  PHOTO_PRINTS
  DIGITAL
  CUSTOM_ORDER
}

enum ProductType {
  TSHIRT
  MUG
  WATER_BOTTLE
  MOUSEMAT
  KEYCHAIN
  CUSHION_PILLOW
  BUSINESS_CARD
  LEAFLET
  GREETING_CARD
  POSTCARD
  BANNER
  POSTER
  CANVAS_PRINT
  ALUMINUM_PRINT
  PHOTO_PAPER_PRINT
  ACRYLIC_LED_PRINT
  DIGITAL_PDF
}

enum CustomizationType {
  TEMPLATE_BASED
  UPLOAD_OWN
  FULLY_CUSTOM
  DIGITAL_DOWNLOAD
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
  OUT_OF_STOCK
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  CARD
  BANK_TRANSFER
  CASH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCategory {
  MATERIALS
  PACKAGING
  SHIPPING_SUPPLIES
  EQUIPMENT
  SOFTWARE
  UTILITIES
  MARKETING
  OTHER
}

enum ReportPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// ============================================
// EMAIL SUBSCRIBER SYSTEM
// ============================================

model Subscriber {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String           @unique @db.VarChar(255)
  name           String?          @db.VarChar(255)
  status         SubscriberStatus @default(PENDING)
  source         SubscriberSource @default(FOOTER)
  confirmToken   String?          @map("confirm_token") @db.VarChar(255)
  subscribedAt   DateTime?        @map("subscribed_at")
  unsubscribedAt DateTime?        @map("unsubscribed_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @default(now()) @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("subscribers")
}

enum SubscriberStatus {
  PENDING    // Awaiting email confirmation
  ACTIVE     // Confirmed and receiving emails
  UNSUBSCRIBED
}

enum SubscriberSource {
  FOOTER
  CHECKOUT
  POPUP
  ADMIN      // Manually added by admin
}

// ============================================
// PROMO/DISCOUNT SYSTEM
// ============================================

model Promo {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String      @unique @db.VarChar(50)
  name            String      @db.VarChar(255)
  description     String?

  // Discount configuration
  discountType    DiscountType @map("discount_type")
  discountValue   Decimal      @map("discount_value") @db.Decimal(10, 2) // Percentage (0-100) or fixed amount

  // Scope: what the promo applies to
  scope           PromoScope   @default(ALL_PRODUCTS)
  categoryId      String?      @map("category_id") @db.Uuid
  subcategoryId   String?      @map("subcategory_id") @db.Uuid
  productIds      String[]     @map("product_ids") @db.Uuid // For specific products

  // Validity period
  startsAt        DateTime?    @map("starts_at")
  expiresAt       DateTime?    @map("expires_at")

  // Usage limits
  maxUses         Int?         @map("max_uses")         // Total uses allowed (null = unlimited)
  maxUsesPerUser  Int          @default(1) @map("max_uses_per_user") // Uses per customer (default 1)
  currentUses     Int          @default(0) @map("current_uses")

  // Requirements
  minOrderAmount  Decimal?     @map("min_order_amount") @db.Decimal(10, 2)

  // Status
  isActive        Boolean      @default(true) @map("is_active")

  // Metadata
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @default(now()) @updatedAt @map("updated_at")

  // Relations
  usages          PromoUsage[]

  @@index([code])
  @@index([isActive])
  @@index([startsAt])
  @@index([expiresAt])
  @@index([scope])
  @@map("promos")
}

model PromoUsage {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  promoId     String   @map("promo_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid  // Can be null for guest checkout
  orderId     String?  @map("order_id") @db.Uuid
  email       String?  @db.VarChar(255)          // Track by email for guests

  // Amount saved
  discountAmount Decimal @map("discount_amount") @db.Decimal(10, 2)

  usedAt      DateTime @default(now()) @map("used_at")

  promo       Promo    @relation(fields: [promoId], references: [id], onDelete: Cascade)

  @@index([promoId])
  @@index([userId])
  @@index([email])
  @@index([orderId])
  @@index([usedAt(sort: Desc)])
  @@map("promo_usages")
}

enum DiscountType {
  PERCENTAGE    // e.g., 10% off
  FIXED_AMOUNT  // e.g., Â£5 off
}

enum PromoScope {
  ALL_PRODUCTS      // Applies to entire order
  CATEGORY          // Applies to specific category
  SUBCATEGORY       // Applies to specific subcategory
  SPECIFIC_PRODUCTS // Applies to specific product IDs
}

// ============================================
// EMAIL CAMPAIGN SYSTEM
// ============================================

model EmailCampaign {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String         @db.VarChar(255)
  subject       String         @db.VarChar(255)
  previewText   String?        @map("preview_text") @db.VarChar(255)
  content       String         // HTML content
  plainText     String?        @map("plain_text") // Plain text version

  // Campaign type and targeting
  type          CampaignType   @default(NEWSLETTER)
  promoId       String?        @map("promo_id") @db.Uuid // Link to a promo if announcing one

  // Status and scheduling
  status        CampaignStatus @default(DRAFT)
  scheduledAt   DateTime?      @map("scheduled_at")
  sentAt        DateTime?      @map("sent_at")

  // Stats
  recipientCount Int           @default(0) @map("recipient_count")
  sentCount      Int           @default(0) @map("sent_count")
  failedCount    Int           @default(0) @map("failed_count")

  // Metadata
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at")

  @@index([status])
  @@index([scheduledAt])
  @@index([sentAt(sort: Desc)])
  @@map("email_campaigns")
}

enum CampaignType {
  NEWSLETTER    // General newsletter
  PROMO         // Promotional campaign with promo code
  ANNOUNCEMENT  // Product/feature announcement
  SEASONAL      // Seasonal/holiday campaign
}

enum CampaignStatus {
  DRAFT         // Being edited
  SCHEDULED     // Scheduled for future send
  SENDING       // Currently being sent
  SENT          // Completed
  FAILED        // Failed to send
  CANCELLED     // Cancelled before send
}

// ============================================
// RETURNS & RESOLUTIONS SYSTEM (LEGACY - kept for migration)
// ============================================

model Resolution {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String           @map("order_id") @db.Uuid
  order          Order            @relation(fields: [orderId], references: [id])
  type           ResolutionType
  reason         ResolutionReason
  notes          String?
  imageUrls      Json?            @map("image_urls") // Array of image URLs uploaded by customer

  // For reprints - link to the new order created
  reprintOrderId String?          @map("reprint_order_id") @db.Uuid

  // For refunds
  refundAmount   Decimal?         @map("refund_amount") @db.Decimal(10, 2)
  stripeRefundId String?          @map("stripe_refund_id") @db.VarChar(255)

  // Status tracking
  status         ResolutionStatus @default(PENDING)
  createdBy      String           @map("created_by") @db.Uuid  // User who created (customer or admin)
  createdAt      DateTime         @default(now()) @map("created_at")
  processedAt    DateTime?        @map("processed_at")

  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("resolutions")
}

enum ResolutionType {
  REPRINT
  REFUND
}

enum ResolutionReason {
  DAMAGED_IN_TRANSIT
  QUALITY_ISSUE
  WRONG_ITEM
  PRINTING_ERROR
  OTHER
}

enum ResolutionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// ENHANCED ISSUE SYSTEM (per-item with correspondence)
// ============================================

model Issue {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderItemId     String           @unique @map("order_item_id") @db.Uuid
  orderItem       OrderItem        @relation(fields: [orderItemId], references: [id])

  // Issue details
  reason          IssueReason
  status          IssueStatus      @default(SUBMITTED)
  carrierFault    CarrierFault     @default(UNKNOWN) @map("carrier_fault")

  // Customer-provided evidence
  initialNotes    String?          @map("initial_notes")
  imageUrls       Json?            @map("image_urls") // String[]

  // Resolution tracking
  resolvedType    IssueResolutionType? @map("resolved_type")
  reprintOrderId  String?          @map("reprint_order_id") @db.Uuid
  reprintItemId   String?          @map("reprint_item_id") @db.Uuid
  refundAmount    Decimal?         @map("refund_amount") @db.Decimal(10, 2)
  stripeRefundId  String?          @map("stripe_refund_id") @db.VarChar(255)

  // Reprint chain tracking (for reprints of reprints)
  originalIssueId String?          @map("original_issue_id") @db.Uuid
  originalIssue   Issue?           @relation("IssueChain", fields: [originalIssueId], references: [id])
  childIssues     Issue[]          @relation("IssueChain")

  // Rejection tracking
  rejectionReason String?          @map("rejection_reason")
  rejectionFinal  Boolean          @default(false) @map("rejection_final")

  // Carrier claim tracking (for Royal Mail insurance claims)
  claimReference    String?        @map("claim_reference") @db.VarChar(100)
  claimStatus       ClaimStatus    @default(NOT_FILED) @map("claim_status")
  claimSubmittedAt  DateTime?      @map("claim_submitted_at")
  claimPayoutAmount Decimal?       @map("claim_payout_amount") @db.Decimal(10, 2)
  claimPaidAt       DateTime?      @map("claim_paid_at")
  claimNotes        String?        @map("claim_notes")

  // Timestamps
  createdBy       String           @map("created_by") @db.Uuid
  createdAt       DateTime         @default(now()) @map("created_at")
  reviewedAt      DateTime?        @map("reviewed_at")
  processedAt     DateTime?        @map("processed_at")
  closedAt        DateTime?        @map("closed_at")

  // Correspondence
  messages        IssueMessage[]

  @@index([status])
  @@index([carrierFault])
  @@index([createdAt(sort: Desc)])
  @@map("issues")
}

model IssueMessage {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  issueId     String        @map("issue_id") @db.Uuid
  issue       Issue         @relation(fields: [issueId], references: [id], onDelete: Cascade)

  sender      MessageSender
  senderId    String        @map("sender_id") @db.Uuid
  content     String
  imageUrls   Json?         @map("image_urls") // String[]

  // Email notification tracking
  emailSent   Boolean       @default(false) @map("email_sent")
  emailSentAt DateTime?     @map("email_sent_at")
  readAt      DateTime?     @map("read_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([issueId])
  @@index([createdAt(sort: Desc)])
  @@map("issue_messages")
}

// Enhanced Issue Status - reflects full lifecycle
enum IssueStatus {
  SUBMITTED           // Customer just submitted issue
  AWAITING_REVIEW     // Ready for admin review
  INFO_REQUESTED      // Admin requested more information
  APPROVED_REPRINT    // Admin approved for reprint
  APPROVED_REFUND     // Admin approved for refund
  PROCESSING          // Reprint/refund in progress
  COMPLETED           // Issue fully resolved
  REJECTED            // Admin rejected the issue
  CLOSED              // Final closure (after appeal or timeout)
}

// Who sent the message
enum MessageSender {
  CUSTOMER
  ADMIN
}

// Carrier fault determination
enum CarrierFault {
  UNKNOWN             // Not yet determined
  CARRIER_FAULT       // Carrier is at fault (for insurance claims)
  NOT_CARRIER_FAULT   // Not carrier's fault
}

// Carrier insurance claim status
enum ClaimStatus {
  NOT_FILED           // No claim filed yet
  SUBMITTED           // Claim submitted to carrier
  UNDER_REVIEW        // Carrier reviewing claim
  APPROVED            // Claim approved, awaiting payment
  REJECTED            // Claim rejected by carrier
  PAID                // Compensation received
}

// Issue reasons (enhanced from ResolutionReason)
enum IssueReason {
  DAMAGED_IN_TRANSIT  // Auto-flags carrier fault
  QUALITY_ISSUE
  WRONG_ITEM
  PRINTING_ERROR
  NEVER_ARRIVED       // Different from damaged - item never received
  OTHER
}

// Resolution type for approved issues
enum IssueResolutionType {
  REPRINT
  FULL_REFUND
  PARTIAL_REFUND
}
